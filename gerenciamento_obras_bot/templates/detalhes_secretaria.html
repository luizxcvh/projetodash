{% extends "base.html" %}

{# Define o título da aba e o cabeçalho usando o nome da secretaria #}
{% block title %}Painel de {{ secretaria.nome }}{% endblock %}
{% block header_title %}{{ secretaria.nome }}{% endblock %}
{% block header_subtitle %}Painel de gestão com todas as obras associadas.{% endblock %}

{% block content %}
<div class="dashboard-container">
    {# Este é o loop crucial que desenha um card para cada obra #}
    {% for obra in secretaria.obras %}
    <div class="card">
        <div class="card-header">
            <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.472-2.472a3.375 3.375 0 00-4.773-4.773L6.75 5.25l-2.472 2.472a3.375 3.375 0 004.773 4.773z" />
            </svg>
            <h2>{{ obra.nome }}</h2>
        </div>

        <div class="chart-container">
            <canvas class="obra-chart" id="chart-obra-{{ obra.id }}" data-id="{{ obra.id }}"></canvas>
        </div>

        <div class="info">
            <p>
                <strong>Orçamento Previsto:</strong>
                <span>{{ obra.orcamento_previsto | currency }}</span>
            </p>
            <p>
                <strong>Total Gasto:</strong>
                <span class="text-gasto">{{ obra.total_gasto | currency }}</span>
            </p>
            <p>
                <strong>Saldo Restante:</strong>
                <span class="text-disponivel">{{ (obra.orcamento_previsto - obra.total_gasto) | currency }}</span>
            </p>
        </div>

        <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">

        <div class="actions-group" style="justify-content: center;">
            <a href="{{ url_for('detalhes_obra', obra_id=obra.id) }}" class="btn btn-sm">Gerir Gastos</a>
            <a href="{{ url_for('editar_obra', obra_id=obra.id) }}" class="btn btn-sm btn-editar">Editar</a>
            <form action="{{ url_for('remover_obra', obra_id=obra.id) }}" method="POST" onsubmit="return confirm('Tem a certeza que deseja remover esta obra?');">
                <button type="submit" class="btn btn-sm btn-remover-perigo">Remover</button>
            </form>
        </div>
    </div>
    {% else %}
    {# Este bloco é exibido se a secretaria não tiver nenhuma obra cadastrada #}
    <div class="card" style="grid-column: 1 / -1;"> {# Ocupa a largura toda #}
        <div class="card-header">
            <h2>Nenhuma Obra Encontrada</h2>
        </div>
        <p>Ainda não há obras cadastradas para a secretaria <strong>{{ secretaria.nome }}</strong>.</p>
        <p>Para começar, adicione a primeira na página de <a href="{{ url_for('listar_obras') }}">Obras</a>, ou use o bot no Telegram.</p>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
    {# É importante garantir que os scripts sejam carregados nesta página também #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}